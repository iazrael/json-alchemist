# 新增配色选项与AI修复提示词优化设计文档

## 需求概述

本次更新包含两个主要功能改进：
1. 增加更多配色选项，改善用户体验
2. 优化AI修复功能的提示词，确保AI只修复JSON而不直接回答问题

## 设计方案

### 1. 配色选项扩展

#### 当前状态分析
- 当前应用使用单一的深色主题（slate色调系）
- 主要颜色包括：slate-950, slate-900, slate-800等
- 缺乏视觉多样性，用户反馈过于单调

#### 设计目标
- 提供多种预设主题配色方案
- 允许用户在设置中选择喜欢的主题
- 保持界面的一致性和专业感

#### 实现方案
1. 添加主题配置管理：
   - 创建主题配置系统，支持多种配色方案
   - 默认提供3-4种主题：深色（当前）、浅色、蓝色调、绿色调

2. 在设置面板中增加主题选择功能：
   - 在现有AI设置基础上增加主题选择区域
   - 提供可视化预览或简单的颜色示例展示

3. 实现动态主题切换：
   - 使用CSS变量管理主题色值
   - 切换主题时动态更新界面样式

#### 主题配色方案定义

| 主题名称 | 背景色 | 主要文字色 | 次要文字色 | 边框色 | 强调色 |
|---------|--------|------------|------------|--------|--------|
| 深色主题（默认） | slate-950 | slate-200 | slate-400 | slate-800 | brand-500 |
| 浅色主题 | neutral-50 | neutral-800 | neutral-600 | neutral-200 | brand-600 |
| 蓝色调 | blue-950 | blue-100 | blue-300 | blue-800 | cyan-400 |
| 绿色调 | emerald-950 | emerald-100 | emerald-300 | emerald-800 | lime-400 |

### 2. AI修复提示词优化

#### 当前问题分析
当用户输入LLM对话历史（如包含system/user角色的JSON数组）时，AI会误认为这是需要它回答的问题，而不是需要修复的JSON格式，这不符合预期行为。

#### 设计目标
- 将所有输入都视为需要修复的JSON数据，包括看起来像LLM对话历史的输入
- 优化提示词使AI专注于JSON修复任务
- 保持对各种JSON格式（包括JSON5和Go结构体）的支持
- 即使输入看起来像LLM对话历史，也要正确修复并返回标准JSON格式

#### 实现方案
1. 修改Gemini服务提示词：
   ```
   你是一个严格的JSON转换和修复引擎。
   
   输入：可能是格式错误的JSON字符串、JSON5字符串或Go语言结构体/映射转储。
   
   任务：
   1. 如果输入是Go语言格式（结构体、映射、切片）：
      - 转换为有效的JSON
      - 将"map[string]interface{}"语法转换为JSON对象"{}"
      - 将"StructName{}"语法转换为JSON对象"{}"
      - 给所有对象键添加引号
      - 如果值是无法解析为字面量的变量引用（如config.Value）或函数调用（如Call(x)），将表达式转换为字符串
   2. 如果输入是格式错误的JSON/JSON5：
      - 修复语法错误（缺少引号、尾随逗号、括号不匹配等）
      - 移除注释
   3. 如果输入看起来像LLM对话历史（包含role/content字段的对象数组），也要当作普通JSON处理：
      - 修复可能存在的语法错误
      - 确保输出是有效的标准JSON格式
   4. 如果输入看起来像是自然语言指令而不是JSON数据：
      - 回复："ERROR: 输入不是有效的JSON或Go结构体，请提供需要修复的JSON数据。"
   5. 返回且仅返回有效的、压缩的JSON字符串
   6. 不要用markdown代码块包裹输出
   7. 不要包含任何解释
   
   输入：
   ${malformedJson}
   ```

2. 修改OpenAI服务提示词：
   ```
   你是一个严格的JSON转换和修复引擎。
   
   输入：可能是格式错误的JSON字符串、JSON5字符串或Go语言结构体/映射转储。
   
   任务：
   1. 如果输入是Go语言格式（结构体、映射、切片）：
      - 转换为有效的JSON
      - 将"map[string]interface{}"语法转换为JSON对象"{}"
      - 将"StructName{}"语法转换为JSON对象"{}"
      - 给所有对象键添加引号
      - 如果值是无法解析为字面量的变量引用或函数调用，将其转换为字符串
   2. 如果输入是格式错误的JSON/JSON5：
      - 修复语法错误
      - 移除注释
   3. 如果输入看起来像LLM对话历史（包含role/content字段的对象数组），也要当作普通JSON处理：
      - 修复可能存在的语法错误
      - 确保输出是有效的标准JSON格式
   4. 如果输入看起来像是自然语言指令而不是JSON数据：
      - 回复："ERROR: 输入不是有效的JSON或Go结构体，请提供需要修复的JSON数据。"
   5. 返回且仅返回有效的、压缩的JSON字符串
   6. 不要用markdown代码块包裹输出
   7. 不要包含任何解释
   ```

### 技术实现要点

#### 配色系统实现
1. 在应用状态中添加主题配置：
   ```typescript
   interface ThemeConfig {
     name: string;
     classPrefix: string;
   }
   
   const THEMES = [
     { name: '深色主题', classPrefix: 'dark' },
     { name: '浅色主题', classPrefix: 'light' },
     { name: '蓝调主题', classPrefix: 'blue' },
     { name: '绿调主题', classPrefix: 'green' }
   ];
   ```

2. 在CSS中定义不同主题的变量：
   ```css
   :root.dark {
     --bg-primary: #020617; /* slate-950 */
     --bg-secondary: #0f172a; /* slate-900 */
     --text-primary: #e2e8f0; /* slate-200 */
     --text-secondary: #94a3b8; /* slate-400 */
     --border-color: #1e293b; /* slate-800 */
     --accent-color: #818cf8; /* brand-500 */
   }
   
   :root.light {
     --bg-primary: #fafafa; /* neutral-50 */
     --bg-secondary: #f5f5f5; /* neutral-100 */
     --text-primary: #171717; /* neutral-900 */
     --text-secondary: #525252; /* neutral-600 */
     --border-color: #e5e5e5; /* neutral-200 */
     --accent-color: #4f46e5; /* brand-600 */
   }
   ```

3. 在设置面板中添加主题选择器组件

#### AI提示词优化实现
1. 在AI服务中增强输入检测逻辑，将所有输入都视为需要修复的JSON数据
2. 更新提示词以明确处理各种JSON格式，包括看起来像LLM对话历史的输入
3. 在前端添加对ERROR回复的特殊处理，向用户显示友好的错误信息

## 用户体验优化

1. 配色选项让用户可以根据个人喜好定制界面外观
2. 改进后的AI修复功能能够将所有输入（包括看起来像LLM对话历史的输入）都正确修复为标准JSON格式
3. 错误提示更加明确，帮助用户理解正确的使用方式

## 向后兼容性

1. 所有更改都向后兼容，不会影响现有功能
2. 默认主题保持原有深色风格，不影响现有用户的使用习惯
3. AI修复功能的核心能力保持不变，仅优化了边缘情况处理

## 测试建议

1. 验证各主题配色在不同组件中的显示效果
2. 测试AI修复功能对各种边界情况的处理：
   - 正常损坏的JSON
   - Go结构体
   - LLM对话历史（如用户提供的示例）
   - 自然语言提示词
   - 空输入
   - 确保LLM对话历史被正确修复为标准JSON格式
3. 确认主题切换的流畅性和正确性   - 空输入
